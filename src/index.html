<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Console</title>
        <script src="./assets/bundle.js" type="module"></script>
        <script src="./utils.js" type="module"></script>
        <script src="./check-repo-updates.js" type="module"></script>
        <script src="./contextmenu.js" type="module"></script>
        <script src="./graph/nodeFactory.js" type="module"></script>
        <!--<script src="./drawflow.js" type="module"></script>-->
        <link rel="stylesheet" type="text/css" href="./assets/codemirror.css">
        <link rel="stylesheet" type="text/css" href="./assets/drawflow.min.css">
        <link rel="stylesheet" type="text/css" href="./drawflow.css">
        <link rel="stylesheet" type="text/css" href="./contextmenu.css">
        <script defer data-domain="foerderfunke.org" src="https://plausible.io/js/script.js"></script>
        <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
        <style>
            #drawflow {
                width: 100%;
                height: 100vh;
            }
            #drawflow .CodeMirror {
                font-size: 12px;
            }
            .drawflow-node {
                width: 414px !important;
            }
            .drawflow-node .box {
                padding-left: 14px !important;
                padding-bottom: 7px !important;
            }
            .result {
                color: silver;
                margin-bottom: 8px;
            }
            .view-only {
                background-color: lightgoldenrodyellow !important;
            }
            .info-node {
                width: 950px !important;
                padding: 8px !important;
                background-color: lightcyan !important;
            }
            .highlighted-edge {
                stroke: red !important;
                stroke-width: 5px !important;
            }
            .highlighted-node {
                background-color: yellow !important;
            }
            .top-menu {
                padding: 10px;
                font-size: small;
            }
        </style>
    </head>
    <body>
        <div class="top-menu">
            <div>Run</div>
        </div>
        <div id="drawflow"></div>
        <script type="module">
            import { checkForNewRepoCommits } from "./check-repo-updates.js"
            import { Drawflow } from "./assets/bundle.js"
            import { Edge } from "./graph/Edge.js"
            import { setupContextMenu } from "./contextmenu.js"
            import { createNode } from "./graph/nodeFactory.js"
            import { Graph } from "./graph/Graph.js"

            // setInterval(checkForNewRepoCommits, 60 * 1000)

            const editor = new Drawflow(document.getElementById("drawflow"))
            editor.start()

            let graph = new Graph()

            editor.container.addEventListener("contextmenu", event => {
                if (event.target.className !== "drawflow") return
                event.stopPropagation()
                setupContextMenu(event, (command, x, y) => {
                    let originalCommand
                    y -= document.getElementById("drawflow").getBoundingClientRect().top
                    let name
                    if (command.startsWith("ex_")) {
                        originalCommand = command
                        name = command.split("_")[2]
                        command = command.split("_")[1]
                    } else {
                        name = prompt("Name of the node", command);
                        if (name == null) return
                    }
                    let node = createNode(command, name, x, y, editor, graph.nodesMap, originalCommand)
                    console.log(node)
                })
            });

           ["mousedown", "mouseup", "mousemove"].forEach(eventType => {
                editor.container.addEventListener(eventType, event => {
                    if (event.button === 2 && event.target.className === "drawflow") {
                        event.stopPropagation()
                    }
                }, true)
            })

            /*editor.on("nodeMoved", function(id) {
                const node = editor.getNodeFromId(id)
                console.log(node.name, node.pos_x, node.pos_y)
            })*/

            editor.on("nodeRemoved", function(id) {
                console.log("nodeRemoved", id)
                // TODO
            })

            editor.on("connectionCreated", connection => {
                let sourceNode = graph.getNodeByEditorId(connection.output_id)
                let targetNode = graph.getNodeByEditorId(connection.input_id)
                // if (!targetNode.acceptedIncomingFrom(sourceNode, connection.output_class, connection.input_class)) TODO
                let edge = new Edge(sourceNode.id, targetNode.id, graph.edgesMap, connection)
                console.log(edge)
            })

            editor.on("connectionRemoved", function(connection) {
                console.log("connectionRemoved", connection)
                // TODO
            })

            /*function showFeatures() {
                alert("Backend can be switched out: in-browser session (default), remote triplestore, local java server, etc.\n\n" +
                    "Export flow graph as Turtle file, maybe in line with github.com/rdf-connect?\n\n" +
                    "Export an entire ready-to-execute implementation in different programming languages based on the flow graph.\n\n" +
                    "... your ideas?")
            }

            const infoNodeHtml = `
                <div class="box">
                    This is a "<a href="https://github.com/Citizen-Knowledge-Graph/console">proof of concept</a>" of a <strong>low code linked data operations flow tool</strong> (working title &#128521;, more low ops than low code actually). It shows a very simplified FörderFunke-example of checking a user's eligibility for one benefit. You can press play, change things (e.g. birthday or min age), press play again etc. But beyond that, a lot is hardcoded in the background for now. The idea is to develop this into a tool where you can drag and drop a variety of nodes and wire them up as you like. For instance, the entire matching logic of FörderFunke could be displayed like this and be shared via a link that encodes the setup. But I imagine it to be useful beyond FörderFunke - it could be neat for didactic purposes and also during the development of linked data operations to quickly prototype things and talk about them together &#129299; More feature ideas <a href="#" onclick="showFeatures()">here</a>. What do you think? <small style="color: silver">benjamin.degenhart@foerderfunke.org</small>
                </div>
            `

            async function compute() {
                let userProfile = components["triples"].codeMirror.getValue()
                let matRule = components["sparql"].codeMirror.getValue()
                let reqProfile = components["shacl"].codeMirror.getValue()
                let constructedQuads = await runSparqlConstructQueryOnRdfString(matRule, userProfile)

                // sparql exec
                let store = new Store()
                for (let quad of constructedQuads) {
                    store.addQuad(quad)
                }
                let sparqlExecTurtle = await serializeStoreToTurtle(store)

                // merge
                store = new Store() // new store: otherwise the order of triples is not nice
                await addRdfStringToStore(userProfile, store)
                for (let quad of constructedQuads) {
                    store.addQuad(quad)
                }
                let mergeTurtle = await serializeStoreToTurtle(store)

                // validation
                await addRdfStringToStore(reqProfile, store)
                let result = await runValidationOnStore(store)
                let valiTurtle = await serializeDatasetToTurtle(result.dataset)

                let edgeEl = document.querySelector(`svg.node_out_${components["triples"].nodeId}.node_in_${components["sparqlExec"].nodeId} path`)
                // edgeEl.classList.add("highlighted-edge")
                let nodeEl = document.getElementById(components["sparqlExec"].nodeId)
                // nodeEl.classList.add("highlighted-node")

                setTimeout(() => {
                    let comp = components["sparqlExec"]
                    comp.codeMirror.setValue(sparqlExecTurtle)
                    editor.updateConnectionNodes(comp.nodeId)
                    // edgeEl.classList.remove("highlighted-edge")
                }, 150)
                setTimeout(() => {
                    let comp = components["merge"]
                    comp.codeMirror.setValue(mergeTurtle)
                    editor.updateConnectionNodes(comp.nodeId)
                }, 450)
                setTimeout(() => {
                    let comp = components["vali"]
                    comp.codeMirror.setValue(valiTurtle)
                    editor.updateConnectionNodes(comp.nodeId)
                }, 750)
            }*/
        </script>
    </body>
</html>
